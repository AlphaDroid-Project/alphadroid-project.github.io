<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>AlphaDroid Banner Generator Demo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <!-- Fonts (site already uses Roboto Flex; include here for standalone demo use) -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg: #0f1115;
                --fg: #e8e6ef;
                --muted: #b7b4c4;
                --card: #171a20;
                --accent: #7c6ef6;
                --accent-2: #9c92ff;
                --border: rgba(255, 255, 255, 0.08);
                --radius: 16px;
            }
            * {
                box-sizing: border-box;
                font-family:
                    "Fredoka",
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    "Helvetica Neue",
                    Arial,
                    sans-serif;
            }
            html,
            body {
                margin: 0;
                padding: 0;
                height: 100%;
                background: var(--bg);
                color: var(--fg);
            }
            header {
                padding: 24px;
            }
            header h1 {
                margin: 0 0 6px;
                font-size: 22px;
                font-weight: 800;
                letter-spacing: 0.2px;
            }
            header p {
                margin: 0;
                color: var(--muted);
                font-size: 13px;
            }
            main {
                display: grid;
                gap: 20px;
                grid-template-columns: 380px 1fr;
                padding: 0 24px 24px;
            }
            @media (max-width: 980px) {
                main {
                    grid-template-columns: 1fr;
                }
            }

            .card {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 16px;
            }

            form .group {
                margin-bottom: 14px;
            }
            form label {
                display: block;
                font-size: 12px;
                color: var(--muted);
                margin-bottom: 6px;
            }
            form input[type="text"],
            form input[type="number"],
            form input[type="url"],
            form textarea,
            form select {
                width: 100%;
                background: #0f1217;
                color: var(--fg);
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 10px 12px;
                outline: none;
                font-size: 14px;
            }
            form textarea {
                resize: vertical;
                min-height: 60px;
            }

            .row {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .row > * {
                flex: 1;
            }

            .hint {
                color: var(--muted);
                font-size: 12px;
                margin-top: 6px;
            }

            .buttons {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 6px;
            }
            button {
                background: var(--accent);
                color: white;
                border: 0;
                padding: 10px 14px;
                border-radius: 12px;
                font-weight: 700;
                cursor: pointer;
                transition:
                    transform 0.12s ease,
                    box-shadow 0.12s ease,
                    background 0.12s ease;
                box-shadow: 0 6px 16px rgba(124, 110, 246, 0.35);
            }
            button:hover {
                transform: translateY(-1px);
                background: var(--accent-2);
            }
            button.secondary {
                background: transparent;
                color: var(--fg);
                border: 1px solid var(--border);
                box-shadow: none;
            }
            button:disabled {
                opacity: 0.5;
                cursor: default;
                transform: none;
            }

            .preview-wrap {
                display: grid;
                gap: 14px;
                grid-template-rows: auto 1fr;
            }
            .preview-actions {
                display: flex;
                gap: 10px;
                align-items: center;
                justify-content: space-between;
            }
            .preview-area {
                min-height: 200px;
                display: grid;
                place-items: center;
                overflow: auto;
                background: #0b0d12;
                border: 1px dashed var(--border);
                border-radius: 12px;
                padding: 10px;
                aspect-ratio: 16/9;
            }
            .preview-area canvas {
                max-width: 100%;
                max-height: 100%;
                width: auto;
                height: auto;
                display: block;
                border-radius: 8px;
                box-shadow:
                    0 10px 30px rgba(0, 0, 0, 0.5),
                    0 0 0 1px rgba(255, 255, 255, 0.04) inset;
                object-fit: contain;
            }
            .small {
                font-size: 12px;
                color: var(--muted);
            }
            .badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.08);
                color: var(--fg);
                font-size: 12px;
                border: 1px solid var(--border);
            }
        </style>
    </head>
    <body>
        <header>
            <h1>AlphaDroid Banner Generator</h1>
            <p>
                Demo page to overlay the text skeleton on a template and export
                as PNG.
            </p>
        </header>

        <main>
            <!-- Controls -->
            <section class="card">
                <form id="controls" novalidate>
                    <div class="group">
                        <label>Device name (you can add a line break)</label>
                        <textarea id="deviceName">
Device Name
Here</textarea
                        >
                    </div>

                    <div class="group">
                        <label>Brand name</label>
                        <input type="text" id="brand" value="AlphaDroid" />
                    </div>

                    <div class="group row">
                        <div>
                            <label>Maintainer</label>
                            <input
                                type="text"
                                id="maintainer"
                                value="Maintainer"
                            />
                        </div>
                        <div>
                            <label>Manufacturer</label>
                            <input
                                type="text"
                                id="manufacturer"
                                value="Manufacturer"
                            />
                        </div>
                    </div>

                    <div class="group">
                        <label>Device</label>
                        <select id="deviceSelect">
                            <option value="">Select a device…</option>
                        </select>
                        <div class="hint">
                            List sourced from device_db.json (priority) and
                            devices.json. Label format: (codename) | (model).
                        </div>
                    </div>

                    <div class="buttons">
                        <button id="btn-generate" type="button">
                            Generate
                        </button>
                        <button
                            id="btn-download"
                            type="button"
                            class="secondary"
                        >
                            Download PNG
                        </button>
                    </div>

                    <div class="hint">
                        Tip: You can tweak fonts/colors by editing the generator
                        options in the script below.
                    </div>
                </form>
            </section>

            <!-- Preview -->
            <section class="card preview-wrap">
                <div class="preview-actions">
                    <div>
                        <span class="badge">Preview</span>
                        <span
                            id="meta"
                            class="small"
                            style="margin-left: 8px"
                        ></span>
                    </div>
                    <div class="small">
                        The generator draws a frame and text overlay; it does
                        not recreate your layout.
                    </div>
                </div>
                <div id="preview" class="preview-area">
                    <div class="small">
                        Click “Generate” to render your banner here.
                    </div>
                </div>
            </section>
        </main>

        <!-- Banner generator library -->
        <script src="../scripts/banner-generator.js"></script>
        <script>
            (function () {
                const els = {
                    deviceName: document.getElementById("deviceName"),
                    brand: document.getElementById("brand"),
                    maintainer: document.getElementById("maintainer"),
                    manufacturer: document.getElementById("manufacturer"),
                    deviceSelect: document.getElementById("deviceSelect"),
                    btnGenerate: document.getElementById("btn-generate"),
                    btnDownload: document.getElementById("btn-download"),
                    preview: document.getElementById("preview"),
                    meta: document.getElementById("meta"),
                };

                // Default sample template bundled in repo
                const SAMPLE_TEMPLATE = "../images/skeleton.png";

                // Helpers to source list from device_db.json (priority) and devices.json
                async function loadJSON(url) {
                    const res = await fetch(url, { cache: "no-cache" });
                    if (!res.ok) throw new Error("Failed to load " + url);
                    return await res.json();
                }
                async function buildDeviceList() {
                    let db = null,
                        devices = null;
                    try {
                        db = await loadJSON("../data/device_db.json");
                    } catch (_) {}
                    try {
                        devices = await loadJSON("../data/devices.json");
                    } catch (_) {}
                    const map = new Map();

                    // device_db.json overrides first (priority), skip hidden
                    if (db && db.overrides) {
                        for (const [code, entry] of Object.entries(
                            db.overrides,
                        )) {
                            if (!entry || entry.hide) continue;
                            const codename = String(
                                entry.codename || code || "",
                            ).toLowerCase();
                            const model = entry.model || "";
                            const oem = entry.oem || "";
                            const maintainer = entry.maintainer || "";
                            if (!codename) continue;
                            map.set(codename, {
                                codename,
                                model,
                                oem,
                                maintainer,
                            });

                            // Aliases are intentionally not added to the dropdown to avoid duplicates.
                        }
                    }

                    // devices.json entries (fallback if not already present)
                    if (devices && Array.isArray(devices.devices)) {
                        for (const it of devices.devices) {
                            let code = String(
                                it?.name || it?.filename || "",
                            ).toLowerCase();
                            // Strip .json extension if present
                            if (code.endsWith(".json")) {
                                code = code.slice(0, -5);
                            }
                            const r = it?.data?.response;
                            const model = r?.device || "";
                            const oem = r?.oem || "";
                            const maintainer = r?.maintainer || "";
                            if (!code) continue;
                            // Only add if not already in device_db
                            if (!map.has(code)) {
                                map.set(code, {
                                    codename: code,
                                    model,
                                    oem,
                                    maintainer,
                                });
                            }
                        }
                    }

                    return Array.from(map.values()).sort((a, b) =>
                        a.codename.localeCompare(b.codename),
                    );
                }
                async function populateDeviceDropdown() {
                    if (!els.deviceSelect) return;
                    try {
                        els.deviceSelect.disabled = true;
                        els.deviceSelect.innerHTML =
                            '<option value="">Loading…</option>';
                        const list = await buildDeviceList();
                        const frag = document.createDocumentFragment();
                        const defaultOpt = document.createElement("option");
                        defaultOpt.value = "";
                        defaultOpt.textContent = "Select a device…";
                        frag.appendChild(defaultOpt);

                        for (const item of list) {
                            const opt = document.createElement("option");

                            opt.value = item.codename;

                            const modelLabel = item.model || "Unknown model";

                            opt.textContent = `(${item.codename}) | ${modelLabel}`;

                            frag.appendChild(opt);
                        }

                        els.deviceSelect.innerHTML = "";
                        els.deviceSelect.appendChild(frag);
                        els.deviceSelect.disabled = false;
                    } catch (e) {
                        console.error("Failed to build device list", e);
                        els.deviceSelect.innerHTML =
                            '<option value="">Failed to load list</option>';
                        els.deviceSelect.disabled = false;
                    }
                }
                function applySelectionToFields(selected) {
                    if (!selected) return;
                    // Reflect selection into text fields so user can see/adjust
                    if (selected.model) els.deviceName.value = selected.model;
                    if (selected.oem) els.manufacturer.value = selected.oem;
                    if (selected.maintainer)
                        els.maintainer.value = selected.maintainer;
                }

                let fileBlobUrl = null;
                let lastResult = null;

                function setBusy(on) {
                    els.btnGenerate.disabled = on;
                    els.btnDownload.disabled = on;
                }

                function revokeFileUrl() {
                    if (fileBlobUrl) {
                        URL.revokeObjectURL(fileBlobUrl);
                        fileBlobUrl = null;
                    }
                }

                function getFilenameBase() {
                    const raw = (els.deviceName.value || "AlphaDroid")
                        .replace(/\s+/g, " ")
                        .trim();
                    const compact = raw
                        .replace(/\s+/g, "-")
                        .replace(/[^a-z0-9\-_.]/gi, "");
                    return `alphadroid-${compact || "banner"}`;
                }

                function clearPreview() {
                    els.preview.innerHTML =
                        '<div class="small">Rendering…</div>';
                }

                function showCanvas(canvas) {
                    els.preview.innerHTML = "";
                    els.preview.appendChild(canvas);
                    els.meta.textContent = `${canvas.width}x${canvas.height} (bitmap), CSS size: ${Math.round(canvas.getBoundingClientRect().width)}x${Math.round(canvas.getBoundingClientRect().height)} px`;
                }

                async function generate() {
                    setBusy(true);
                    try {
                        clearPreview();
                        const width = 1920;
                        const height = 1080;
                        const quality = 1.0;
                        const dpr = Math.max(1, window.devicePixelRatio || 1);

                        const base = {
                            template: SAMPLE_TEMPLATE,
                            width,
                            height,
                            quality,
                            dpr,
                        };
                        let options = { ...base };
                        const selectedCode =
                            els.deviceSelect && els.deviceSelect.value
                                ? els.deviceSelect.value.trim()
                                : "";
                        if (selectedCode) {
                            options.codename = selectedCode;
                            options.brand = els.brand.value;
                            options.lookup = {
                                devicesUrl: "../data/devices.json",
                                deviceDbUrl: "../data/device_db.json",
                            };
                        } else {
                            // Manual mode
                            options.deviceName = els.deviceName.value;
                            options.brand = els.brand.value;
                            options.maintainer = els.maintainer.value;
                            options.manufacturer = els.manufacturer.value;
                        }
                        // Optional: tweak colors/fonts/frame here if you want a different look

                        // options.colors = { textPrimary: '#ECEAF2' };
                        // options.fonts = { family: "'Fredoka', Roboto, Arial, sans-serif" };

                        const out = await BannerGenerator.generate(options);

                        lastResult = out;
                        showCanvas(out.canvas);
                        return out;
                    } catch (e) {
                        console.error(e);
                        els.preview.innerHTML =
                            '<div class="small" style="color:#ff9aa2">Failed to render banner. See console for details.</div>';
                        lastResult = null;
                    } finally {
                        setBusy(false);
                    }
                }

                async function download() {
                    try {
                        if (!lastResult) {
                            await generate();
                            if (!lastResult) return;
                        }
                        const name = getFilenameBase() + ".png";
                        await BannerGenerator.download(lastResult.blob, name);
                    } catch (e) {
                        console.error(e);
                    }
                }

                // Wire up actions
                els.btnGenerate.addEventListener("click", generate);
                els.btnDownload.addEventListener("click", download);

                // Populate dropdown, and reflect selection into fields
                populateDeviceDropdown();
                if (els.deviceSelect) {
                    els.deviceSelect.addEventListener("change", async () => {
                        const code = els.deviceSelect.value;
                        if (!code) return;
                        // Build a small index to find selected quickly (avoid refetch by using last list if needed)
                        try {
                            const list = await (async () =>
                                await buildDeviceList())();
                            const info = list.find((d) => d.codename === code);
                            if (info) applySelectionToFields(info);
                        } catch (_) {}
                    });
                }

                // Auto-preview on changes (debounced)
                const debounce = (fn, wait = 400) => {
                    let t;
                    return (...args) => {
                        clearTimeout(t);
                        t = setTimeout(() => fn.apply(null, args), wait);
                    };
                };
                const auto = debounce(generate, 450);

                [
                    els.deviceName,
                    els.brand,
                    els.maintainer,
                    els.manufacturer,
                ].forEach((el) => {
                    el.addEventListener("input", auto);
                });
                if (els.deviceSelect) {
                    els.deviceSelect.addEventListener("change", auto);
                }

                // Initial render - removed automatic generation
                // generate();

                // Cleanup
                window.addEventListener("beforeunload", revokeFileUrl);
            })();
        </script>
    </body>
</html>
